<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>sssss — admin</title>
    <style>
      :root { --bg:#f7fafc; --fg:#0f172a; --muted:#475569; --accent:#2563eb; --card:#ffffff; --border:#e2e8f0; }
      *{box-sizing:border-box}
      body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;background:var(--bg);color:var(--fg)}
      header{padding:16px;border-bottom:1px solid var(--border);position:sticky;top:0;background:rgba(255,255,255,.9);backdrop-filter: blur(6px)}
      .brand{font-weight:800}
      main{max-width:900px;margin:0 auto;padding:16px}
      .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
      .row{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--border);border-radius:12px;padding:12px;margin:8px 0;background:#fff}
      .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
      .ghost{background:#ffffff;color:var(--fg)}
      .muted{color:var(--muted);font-size:12px}
      .grid{display:grid;gap:10px}
      a{color:var(--accent);text-decoration:none}
      .badge{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;color:var(--muted);font-size:12px}
      code{background:#f1f5f9;border:1px solid var(--border);padding:2px 6px;border-radius:6px}
      .warning{background:#fef3c7;border:1px solid #f59e0b;color:#92400e;padding:12px;border-radius:8px;margin:16px 0}
    </style>
  </head>
  <body>
    <header>
      <div class="brand">sssss — admin</div>
      <div>
        <a href="./">Inicio</a> | 
        <a href="seguimiento.html">Seguimiento</a>
      </div>
    </header>
    <main>
      <div class="warning">
        <strong>⚠️ Modo Desarrollo:</strong> El panel de administración está funcionando sin autenticación por ahora. 
        Para habilitar la autenticación de Google, configura Firebase Auth en la consola de Firebase.
      </div>
      
      <section class="card">
        <h2 style="margin:0 0 8px 0">Exportar respuestas</h2>
        <div class="muted" id="authStatus">Cargando datos...</div>
        <div id="list" class="grid" style="margin-top:12px"></div>
      </section>
    </main>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
      import { getFirestore, collection, getDocs, orderBy, query } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCq05NElKm-01Xyraj6qdF31IgOLf8gQbA",
        authDomain: "sssss-e8013.firebaseapp.com",
        projectId: "sssss-e8013",
        storageBucket: "sssss-e8013.firebasestorage.app",
        messagingSenderId: "765571239773",
        appId: "1:765571239773:web:39ea76d035d314cdd4a2b4",
        measurementId: "G-1JDBES8EE2",
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      const $list = document.getElementById('list');

      // Load survey data immediately (no auth required for now)
      loadSurveyData();

      async function loadSurveyData() {
        try {
          document.getElementById('authStatus').textContent = 'Cargando datos...';
          
          const qRef = query(collection(db, `responses/umag/entries`), orderBy('createdAt', 'desc'));
          const snap = await getDocs(qRef);
          
          if (snap.empty) {
            $list.innerHTML = '<div class="muted">No hay respuestas disponibles.</div>';
            document.getElementById('authStatus').textContent = 'Sin respuestas';
            return;
          }

          const surveys = {};
          snap.forEach(doc => {
            const data = doc.data();
            const surveyId = data.surveyId || 'unknown';
            if (!surveys[surveyId]) {
              surveys[surveyId] = { count: 0, latest: null };
            }
            surveys[surveyId].count++;
            if (!surveys[surveyId].latest || data.createdAt > surveys[surveyId].latest) {
              surveys[surveyId].latest = data.createdAt;
            }
          });

          $list.innerHTML = Object.entries(surveys).map(([id, info]) => `
            <div class="row">
              <div>
                <strong>${id}</strong>
                <div class="muted">${info.count} respuestas</div>
              </div>
              <div>
                <button class="btn" onclick="exportCsv('${id}', 'simplified')">CSV Simplificado</button>
                <button class="btn ghost" onclick="exportCsv('${id}', 'complete')">CSV Completo</button>
              </div>
            </div>
          `).join('');

          document.getElementById('authStatus').textContent = `Cargados ${Object.keys(surveys).length} cuestionarios`;
        } catch (error) {
          console.error('Error loading data:', error);
          $list.innerHTML = '<div class="muted">Error al cargar los datos.</div>';
          document.getElementById('authStatus').textContent = 'Error al cargar datos';
        }
      }

      async function exportCsv(surveyId, exportType = 'simplified') {
        try {
          const qRef = query(collection(db, `responses/${surveyId}/entries`), orderBy('createdAt', 'desc'));
          const snap = await getDocs(qRef);
          
          if (snap.empty) {
            alert('No hay respuestas para exportar.');
            return;
          }

          // Define columns based on export type
          let columns = ['entryId', 'createdAt', 'serverCode', 'participant_id'];
          
          if (exportType === 'complete') {
            columns = columns.concat([
              'totalTime', 'itemTimes', 'browser_userAgent', 'browser_language', 
              'browser_platform', 'browser_screenWidth', 'browser_screenHeight',
              'browser_timezone', 'browser_timestamp', 'browser_referrer', 'browser_url'
            ]);
          }

          // Add survey-specific columns
          const firstDoc = snap.docs[0].data();
          if (firstDoc.answers) {
            Object.keys(firstDoc.answers).forEach(key => {
              if (!columns.includes(key)) {
                columns.push(key);
              }
            });
          }

          const rows = [];
          const seenIds = new Set(); // Prevent duplicates

          snap.forEach(doc => {
            const d = doc.data();
            const participantId = d.answers?.participant_id;
            const serverCode = d.serverCode;
            const duplicateKey = `${participantId}_${serverCode}`;

            if (seenIds.has(duplicateKey)) {
              console.log(`Skipping duplicate: ${duplicateKey}`);
              return;
            }
            seenIds.add(duplicateKey);

            const row = {};
            columns.forEach(col => {
              if (col === 'entryId') {
                row[col] = doc.id;
              } else if (col === 'createdAt') {
                row[col] = d.createdAt ? d.createdAt.toDate().toISOString() : '';
              } else if (col === 'serverCode') {
                row[col] = d.serverCode || '';
              } else if (col === 'participant_id') {
                row[col] = d.answers?.participant_id || '';
              } else if (col.startsWith('browser_')) {
                const browserKey = col.replace('browser_', '');
                row[col] = d.browserData?.[browserKey] || '';
              } else if (col === 'totalTime') {
                row[col] = d.totalTime || '';
              } else if (col === 'itemTimes') {
                row[col] = d.itemTimes ? JSON.stringify(d.itemTimes) : '';
              } else if (d.answers && d.answers.hasOwnProperty(col)) {
                const value = d.answers[col];
                if (Array.isArray(value)) {
                  row[col] = value.join('; ');
                } else {
                  row[col] = value || '';
                }
              } else {
                row[col] = '';
              }
            });
            rows.push(row);
          });

          // Convert to CSV
          const csvContent = [
            columns.join(','),
            ...rows.map(row => 
              columns.map(col => {
                const value = row[col] || '';
                // Escape quotes and wrap in quotes if contains comma, quote, or newline
                if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
                  return `"${value.replace(/"/g, '""')}"`;
                }
                return value;
              }).join(',')
            )
          ].join('\n');

          // Download
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          const url = URL.createObjectURL(blob);
          link.setAttribute('href', url);
          link.setAttribute('download', `respuestas_${surveyId}_${exportType}_${new Date().toISOString().split('T')[0]}.csv`);
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);

          console.log(`Exported ${rows.length} responses (${exportType})`);
        } catch (error) {
          console.error('Error exporting CSV:', error);
          alert('Error al exportar CSV: ' + error.message);
        }
      }

      // Make functions globally available
      window.exportCsv = exportCsv;
    </script>
  </body>
</html>