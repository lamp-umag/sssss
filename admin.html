<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>sssss — admin</title>
    <style>
      :root { --bg:#f7fafc; --fg:#0f172a; --muted:#475569; --accent:#2563eb; --card:#ffffff; --border:#e2e8f0; }
      *{box-sizing:border-box}
      body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;background:var(--bg);color:var(--fg)}
      header{padding:16px;border-bottom:1px solid var(--border);position:sticky;top:0;background:rgba(255,255,255,.9);backdrop-filter: blur(6px)}
      .brand{font-weight:800}
      main{max-width:900px;margin:0 auto;padding:16px}
      .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
      .row{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--border);border-radius:12px;padding:12px;margin:8px 0;background:#fff}
      .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
      .ghost{background:#ffffff;color:var(--fg)}
      .muted{color:var(--muted);font-size:12px}
      .grid{display:grid;gap:10px}
      a{color:var(--accent);text-decoration:none}
      .badge{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;color:var(--muted);font-size:12px}
      code{background:#f1f5f9;border:1px solid var(--border);padding:2px 6px;border-radius:6px}
    </style>
  </head>
  <body>
    <header>
      <div class="brand">sssss — admin</div>
      <div><a href="./">Inicio</a></div>
    </header>
    <main>
      <section class="card">
        <h2 style="margin:0 0 8px 0">Exportar respuestas</h2>
        <div class="muted">Sin autenticación por ahora. Cualquiera con este enlace puede descargar.</div>
        <div id="list" class="grid" style="margin-top:12px"></div>
      </section>

      
    </main>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
      import { getFirestore, collection, getDocs, orderBy, query } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCq05NElKm-01Xyraj6qdF31IgOLf8gQbA",
        authDomain: "sssss-e8013.firebaseapp.com",
        projectId: "sssss-e8013",
        storageBucket: "sssss-e8013.firebasestorage.app",
        messagingSenderId: "765571239773",
        appId: "1:765571239773:web:39ea76d035d314cdd4a2b4",
        measurementId: "G-1JDBES8EE2",
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      const $list = document.getElementById('list');

      async function loadSurveyIndex() {
        const res = await fetch('surveys/index.json?_=' + Date.now());
        const data = await res.json();
        return data.surveys || [];
      }

      function toCsv(rows) {
        if (!rows.length) return '';
        const headers = Object.keys(rows[0]);
        const esc = (v) => {
          if (v == null) return '';
          const s = typeof v === 'string' ? v : JSON.stringify(v);
          const t = s.replaceAll('"', '""');
          return '"' + t + '"';
        };
        const lines = [headers.join(',')];
        for (const r of rows) {
          lines.push(headers.map(h => esc(r[h])).join(','));
        }
        return lines.join('\n');
      }

      function download(filename, text) {
        const blob = new Blob([text], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename; a.click();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
      }

      function normalizeOptions(item) {
        if (!Array.isArray(item.options)) return [];
        return item.options.map((opt, idx) => {
          if (typeof opt === 'string') return { label: opt, code: idx + 1 };
          const label = opt.label ?? String(opt.code ?? opt.value ?? opt);
          const code = opt.code ?? opt.value ?? (idx + 1);
          return { label, code };
        });
      }

      function buildCodebook(survey) {
        return {
          id: survey.id,
          title: survey.title,
          items: survey.items.map(it => ({
            id: it.id,
            type: it.type,
            scale: it.scale || null,
            options: Array.isArray(it.options) ? normalizeOptions(it) : null
          }))
        };
      }

      async function exportCsv(meta) {
        const res = await fetch(`surveys/${meta.file}?_=${Date.now()}`);
        const survey = await res.json();
        const cols = ['entryId', 'createdAt', ...survey.items.map(i => i.id)];
        const qRef = query(collection(db, `responses/${meta.id}/entries`), orderBy('createdAt'));
        const snap = await getDocs(qRef);
        const rows = [];
        snap.forEach(doc => {
          const d = doc.data();
          const row = Object.fromEntries(cols.map(c => [c, null]));
          row.entryId = doc.id;
          try { row.createdAt = d.createdAt?.toDate?.().toISOString?.() || ''; } catch { row.createdAt = ''; }
          const ans = d.answers || {};
          for (const it of survey.items) {
            let v = ans[it.id];
            if (Array.isArray(v)) v = v.join('|');
            row[it.id] = v == null ? '' : v;
          }
          rows.push(row);
        });
        const csv = toCsv(rows);
        const ts = new Date().toISOString().slice(0,19).replaceAll(':','-');
        download(`${meta.id}-${ts}.csv`, csv || '');
      }

      async function downloadCodebook(meta) {
        const res = await fetch(`surveys/${meta.file}?_=${Date.now()}`);
        const survey = await res.json();
        const codebook = buildCodebook(survey);
        const text = JSON.stringify(codebook, null, 2);
        const blob = new Blob([text], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `${meta.id}-codebook.json`; a.click();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
      }

      async function downloadSurveyJson(meta) {
        const res = await fetch(`surveys/${meta.file}?_=${Date.now()}`);
        const survey = await res.json();
        const text = JSON.stringify(survey, null, 2);
        const blob = new Blob([text], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `${meta.id}.json`; a.click();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
      }

      (async function init() {
        const items = await loadSurveyIndex();
        $list.innerHTML = '';
        items.forEach(meta => {
          const row = document.createElement('div');
          row.className = 'row';
          row.innerHTML = `
            <div>
              <div style="font-weight:700">${meta.title}</div>
              <div class="muted">${meta.description || ''} <span class="badge">${meta.id}</span></div>
            </div>
            <div>
              <button class="btn" data-act="csv">CSV</button>
              <button class="btn ghost" data-act="codebook">Esquema</button>
              <button class="btn ghost" data-act="json">JSON</button>
            </div>
          `;
          row.querySelector('[data-act=csv]').addEventListener('click', () => exportCsv(meta));
          row.querySelector('[data-act=codebook]').addEventListener('click', () => downloadCodebook(meta));
          row.querySelector('[data-act=json]').addEventListener('click', () => downloadSurveyJson(meta));
          $list.appendChild(row);
        });
      })();
    </script>
  </body>
  </html>


