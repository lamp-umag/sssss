<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>sssss â€” seguimiento</title>
    <style>
      :root { 
        --bg:#f7fafc; 
        --fg:#0f172a; 
        --muted:#475569; 
        --accent:#2563eb; 
        --card:#ffffff; 
        --border:#e2e8f0;
        --ok: #16a34a;
        --warn: #d97706;
        --error: #dc2626;
      }
      *{box-sizing:border-box}
      body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;background:var(--bg);color:var(--fg)}
      header{padding:16px;border-bottom:1px solid var(--border);position:sticky;top:0;background:rgba(255,255,255,.9);backdrop-filter: blur(6px)}
      .brand{font-weight:800}
      main{max-width:1200px;margin:0 auto;padding:16px}
      .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.04);margin-bottom:16px}
      .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:var(--accent);color:#fff;font-weight:700;cursor:pointer;margin:4px}
      .ghost{background:#ffffff;color:var(--fg)}
      .muted{color:var(--muted);font-size:12px}
      .grid{display:grid;gap:10px}
      a{color:var(--accent);text-decoration:none}
      .badge{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;color:var(--muted);font-size:12px}
      code{background:#f1f5f9;border:1px solid var(--border);padding:2px 6px;border-radius:6px}
      .stats{display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;margin-bottom:20px}
      .stat-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center}
      .stat-number{font-size:24px;font-weight:700;color:var(--accent)}
      .stat-label{font-size:14px;color:var(--muted);margin-top:4px}
      .participant-list{max-height:400px;overflow-y:auto;border:1px solid var(--border);border-radius:8px}
      .participant-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid var(--border);background:#fff}
      .participant-item:last-child{border-bottom:none}
      .participant-code{font-weight:700;font-family:monospace}
      .participant-time{font-size:12px;color:var(--muted)}
      .refresh-btn{position:fixed;bottom:20px;right:20px;z-index:1000}
      .loading{text-align:center;padding:20px;color:var(--muted)}
      .error{color:var(--error);text-align:center;padding:20px}
    </style>
  </head>
  <body>
    <header>
      <div class="brand">sssss â€” seguimiento</div>
      <div><a href="./">Inicio</a> | <a href="admin2.html">Admin</a></div>
    </header>
    <main>
      <section class="card">
        <h2 style="margin:0 0 8px 0">Seguimiento de Participantes</h2>
        <div class="muted">CÃ³digos de participantes que han completado el cuestionario UMAG</div>
        
        <div class="stats" id="stats">
          <div class="stat-card">
            <div class="stat-number" id="totalResponses">-</div>
            <div class="stat-label">Total Respuestas</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="uniqueParticipants">-</div>
            <div class="stat-label">Participantes Ãšnicos</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="serverCodes">-</div>
            <div class="stat-label">CÃ³digos de Servidor</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="avgTime">-</div>
            <div class="stat-label">Tiempo Promedio (min)</div>
          </div>
        </div>

        <div style="margin-bottom:16px">
          <button class="btn" onclick="refreshData()">ðŸ”„ Actualizar</button>
          <button class="btn ghost" onclick="exportParticipantList()">ðŸ“¥ Exportar Lista</button>
          <button class="btn" onclick="exportUMAGResponses()">ðŸ“Š Descargar Respuestas UMAG</button>
        </div>

        <div class="participant-list" id="participantList">
          <div class="loading">Cargando datos...</div>
        </div>
      </section>
    </main>

    <button class="btn refresh-btn" onclick="refreshData()" title="Actualizar datos">ðŸ”„</button>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
      import { getFirestore, collection, getDocs, orderBy, query } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCq05NElKm-01Xyraj6qdF31IgOLf8gQbA",
        authDomain: "sssss-e8013.firebaseapp.com",
        projectId: "sssss-e8013",
        storageBucket: "sssss-e8013.firebasestorage.app",
        messagingSenderId: "765571239773",
        appId: "1:765571239773:web:39ea76d035d314cdd4a2b4",
        measurementId: "G-1JDBES8EE2",
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      let participants = [];
      let serverCodes = new Set();

      // Define the exact order of columns based on the UMAG survey structure
      const UMAG_COLUMNS = [
        'participant_id',
        'serverCode',
        'art_1',
        'art_2', 
        'art_3',
        'art_4',
        'art_activities',
        'sport_1',
        'sport_2',
        'sport_3',
        'sport_4',
        'sport_activities',
        'music_1',
        'music_2',
        'music_3',
        'music_4',
        'music_genres',
        'music_artists',
        'control_1',
        'control_2',
        'control_3',
        'control_4',
        'control_5',
        'red_flags',
        'university_1',
        'university_2',
        'university_3',
        'university_4',
        'university_5',
        'university_6',
        'university_7',
        'gambling_1',
        'gambling_2',
        'gambling_3',
        'gambling_4',
        'gambling_types',
        'personality_1',
        'personality_2',
        'personality_3',
        'personality_4',
        'personality_5',
        'personality_6',
        'personality_7',
        'personality_8',
        'personality_9',
        'personality_10',
        'personality_11',
        'personality_12',
        'personality_13',
        'personality_14',
        'personality_15',
        'personality_16',
        'personality_17',
        'personality_18',
        'personality_19',
        'personality_20',
        'personality_21',
        'personality_22',
        'personality_23',
        'personality_24',
        'personality_25',
        'personality_26',
        'personality_27',
        'personality_28',
        'personality_29',
        'personality_30',
        'personality_31',
        'personality_32',
        'personality_33',
        'ai_1',
        'ai_2',
        'ai_3',
        'ai_4',
        'ai_5',
        'ai_6',
        'ai_tools',
        'ai_uses',
        'wellbeing_1',
        'wellbeing_2',
        'wellbeing_3',
        'wellbeing_4',
        'wellbeing_5',
        'mood_enthusiastic',
        'mood_nervous',
        'mood_inspired',
        'mood_restless',
        'mood_determined',
        'mood_fearful',
        'mood_active',
        'mood_ashamed',
        'mood_attentive',
        'mood_distressed',
        'gender',
        'work_status',
        'location',
        'relationship_status',
        'religious_orientation',
        'political_orientation',
        'study_area'
      ];

      async function loadData() {
        try {
          document.getElementById('participantList').innerHTML = '<div class="loading">Cargando datos...</div>';
          
          const qRef = query(collection(db, 'responses/umag/entries'), orderBy('createdAt', 'desc'));
          const snap = await getDocs(qRef);
          
          participants = [];
          serverCodes.clear();
          
          snap.forEach(doc => {
            const data = doc.data();
            const participantId = data.answers?.participant_id;
            const serverCode = data.serverCode;
            
            if (participantId) {
              participants.push({
                id: doc.id,
                participantId: participantId,
                serverCode: serverCode || 'Sin cÃ³digo',
                createdAt: data.createdAt?.toDate?.() || new Date(),
                totalTime: data.totalTime || 0,
                answers: data.answers || {}
              });
              
              if (serverCode) {
                serverCodes.add(serverCode);
              }
            }
          });
          
          updateStats();
          updateParticipantList();
          
        } catch (error) {
          console.error('Error loading data:', error);
          document.getElementById('participantList').innerHTML = '<div class="error">Error al cargar los datos. Intenta de nuevo.</div>';
        }
      }

      function updateStats() {
        const totalResponses = participants.length;
        const uniqueParticipants = new Set(participants.map(p => p.participantId)).size;
        const uniqueServerCodes = serverCodes.size;
        
        const avgTime = participants.length > 0 
          ? Math.round(participants.reduce((sum, p) => sum + (p.totalTime || 0), 0) / participants.length / 1000 / 60 * 10) / 10
          : 0;
        
        document.getElementById('totalResponses').textContent = totalResponses;
        document.getElementById('uniqueParticipants').textContent = uniqueParticipants;
        document.getElementById('serverCodes').textContent = uniqueServerCodes;
        document.getElementById('avgTime').textContent = avgTime;
      }

      function updateParticipantList() {
        const list = document.getElementById('participantList');
        
        if (participants.length === 0) {
          list.innerHTML = '<div class="loading">No hay respuestas aÃºn</div>';
          return;
        }
        
        const html = participants.map(p => {
          const timeStr = p.totalTime ? `${Math.round(p.totalTime / 1000 / 60)} min` : 'N/A';
          const dateStr = p.createdAt.toLocaleString('es-CL');
          
          return `
            <div class="participant-item">
              <div>
                <div class="participant-code">${p.participantId}</div>
                <div class="participant-time">${dateStr} â€¢ ${timeStr}</div>
              </div>
              <div>
                <span class="badge">${p.serverCode}</span>
              </div>
            </div>
          `;
        }).join('');
        
        list.innerHTML = html;
      }

      function exportParticipantList() {
        const csv = [
          ['CÃ³digo Participante', 'CÃ³digo Servidor', 'Fecha', 'Tiempo Total (min)', 'ID Respuesta'],
          ...participants.map(p => [
            p.participantId,
            p.serverCode,
            p.createdAt.toISOString(),
            p.totalTime ? Math.round(p.totalTime / 1000 / 60) : '',
            p.id
          ])
        ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `participantes-umag-${new Date().toISOString().slice(0,19).replaceAll(':','-')}.csv`;
        a.click();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
      }

      async function exportUMAGResponses() {
        try {
          const qRef = query(collection(db, 'responses/umag/entries'), orderBy('createdAt', 'desc'));
          const snap = await getDocs(qRef);
          
          if (snap.empty) {
            alert('No hay respuestas para exportar.');
            return;
          }

          // Create CSV with exact column order and empty cells for missing responses
          const csvRows = [
            UMAG_COLUMNS.join(',')
          ];

          snap.forEach(doc => {
            const data = doc.data();
            const answers = data.answers || {};
            
            const row = UMAG_COLUMNS.map(column => {
              let value = '';
              
              if (column === 'participant_id') {
                value = answers.participant_id || '';
              } else if (column === 'serverCode') {
                value = data.serverCode || '';
              } else if (answers.hasOwnProperty(column)) {
                const val = answers[column];
                if (Array.isArray(val)) {
                  value = val.join('; ');
                } else {
                  value = val || '';
                }
              }
              // If column doesn't exist in answers, value remains empty string
              
              // Escape CSV values
              if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
                return `"${value.replace(/"/g, '""')}"`;
              }
              return value;
            });
            
            csvRows.push(row.join(','));
          });

          const csvContent = csvRows.join('\n');
          
          // Download file
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `respuestas-umag-${new Date().toISOString().slice(0,19).replaceAll(':','-')}.csv`;
          a.click();
          setTimeout(() => URL.revokeObjectURL(url), 1000);
          
          console.log(`Exported ${snap.size} UMAG responses with ${UMAG_COLUMNS.length} columns`);
        } catch (error) {
          console.error('Error exporting UMAG responses:', error);
          alert('Error al exportar respuestas: ' + error.message);
        }
      }

      function refreshData() {
        loadData();
      }

      // Make functions globally available
      window.refreshData = refreshData;
      window.exportParticipantList = exportParticipantList;
      window.exportUMAGResponses = exportUMAGResponses;

      // Auto-refresh every 30 seconds
      setInterval(refreshData, 30000);

      // Load data on page load
      loadData();
    </script>
  </body>
</html>
